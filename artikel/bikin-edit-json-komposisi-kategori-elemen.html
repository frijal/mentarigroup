<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Editor JSON (Format Galeri Produk)</title>
  <style>
  /* --- Global & Typography --- */
  *,
  *::before,
  *::after {
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
    background-color: #f4f7f6;
    color: #333;
    margin: 0;
    padding: 24px;
    line-height: 1.5;
  }

  h1, h2, h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-weight: 600;
    line-height: 1.2;
  }

  h1 {
    font-size: 2.25rem;
    color: #2c3e50;
    margin-bottom: 24px;
  }

  h2 {
    font-size: 1.75rem;
    color: #34495e;
    border-bottom: 2px solid #ecf0f1;
    padding-bottom: 8px;
  }

  h3 {
    font-size: 1.25rem;
    color: #333;
  }

  p {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 1rem;
  }

  code {
    background: #ecf0f1;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: Consolas, monaco, monospace;
  }

  hr {
    display: none;
  }

  /* --- Layout Card --- */
  .card {
    background: #ffffff;
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  /* --- Form Inputs & Labels --- */
  label {
    display: block;
    margin-bottom: 6px;
    margin-top: 16px;
    font-weight: 500;
    color: #555;
  }

  input[type=text],
  input[type=date],
  textarea,
  input[type=file] {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
    font-family: inherit;
    background-color: #fafafa;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  /* Override untuk input file di card pertama */
  .card:first-of-type input[type=file] {
      max-width: 600px;
  }

  /* Override untuk input nama kategori */
  #categoryName {
      max-width: 600px;
  }

  input[type=text]:focus,
  input[type=date]:focus,
  textarea:focus {
    outline: none;
    border-color: #3498db;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    background-color: #fff;
  }

  textarea {
    min-height: 80px;
    resize: vertical;
  }

  input[type=file] {
    padding: 10px;
    background: #fafafa;
    cursor: pointer;
  }

  input[type=file]::file-selector-button {
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    background-color: #34495e;
    color: white;
    cursor: pointer;
    margin-right: 12px;
    transition: background-color 0.2s;
  }

  input[type=file]::file-selector-button:hover {
    background-color: #2c3e50;
  }

  /* --- Buttons --- */
  button {
    padding: 12px 20px;
    font-size: 1rem;
    font-weight: 600;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  #generateJsonBtn {
    background-color: #2ecc71;
    color: white;
    font-size: 1.1rem;
    width: 100%;
    max-width: 600px;
    margin-top: 24px;
  }
  #generateJsonBtn:hover {
    background-color: #27ae60;
  }

  #addElementBtn {
    background-color: #3498db;
    color: white;
  }
  #addElementBtn:hover {
    background-color: #2980b9;
  }

  .remove-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    background: #e74c3c;
    color: white;
    font-weight: bold;
    padding: 0;
    font-size: 1.25rem;
    line-height: 28px;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    box-shadow: none;
    z-index: 20; /* Pastikan di atas preview */
  }
  .remove-btn:hover {
    background: #c0392b;
    transform: none;
    box-shadow: none;
  }

  /* --- Containers --- */
  .category-block {
    border: 1px solid #e0e0e0;
    margin-top: 24px;
    padding: 20px;
    background: #fdfdfd;
    border-radius: 8px;
  }

  .elements-list {
    margin-top: 16px;
  }

  /* --- Elemen Row & Preview --- */
  .element-row {
    border: none;
    padding: 0;
    margin-bottom: 16px;
    background: transparent;
    position: relative;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    overflow: hidden;
  }

  .element-row-flex {
    display: flex;
    flex-wrap: wrap; /* Agar responsif di layar kecil */
    border: 1px solid #e0e0e0;
    background: white;
  }

  .element-inputs {
    flex: 2; /* Kolom input mengambil 2 bagian */
    min-width: 300px; /* Lebar minimum sebelum wrapping */
    padding: 20px;
    padding-top: 24px;
    border-right: 1px solid #f0f0f0;
  }

  .element-preview {
    flex: 1; /* Kolom preview mengambil 1 bagian */
    min-width: 250px;
    padding: 20px;
    background: #fcfcfc;
    position: relative;
  }

  .preview-card {
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    background: #fff;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    position: sticky; /* Tetap terlihat saat scroll kolom input */
    top: 20px;
  }

  .preview-image {
    width: 100%;
    height: 150px;
    object-fit: cover;
    background: #f0f0f0;
    color: #aaa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
  }

  .preview-content {
    padding: 16px;
  }

  .preview-title {
    font-size: 1.1rem; /* Dikecilkan sedikit */
    font-weight: 600;
    margin: 0 0 8px 0;
    color: #333;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .preview-desc {
    font-size: 0.9rem;
    color: #666;
    margin: 0 0 12px 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .preview-date { /* Diubah jadi SubKategori1_2 */
    font-size: 0.8rem;
    font-weight: 500;
    color: #999;
  }

  /* --- Penyesuaian Label di Dalam Row --- */
  .element-inputs label {
    margin-top: 12px;
  }

  .element-inputs label:first-of-type {
    margin-top: 0;
  }
</style>
</head>
<body>

  <h1>Editor JSON Galeri Produk</h1>
  <div class="card">
    <h2>1. Muat Data (Wajib)</h2>
    <p>Muat file <code>data.json</code> Anda untuk memulai.</p>
    <label for="loadJsonFile">Muat file <code>data.json</code>:</label>
    <input type="file" id="loadJsonFile" accept="application/json">
  </div>

  <div class="card">
    <h2>2. Edit Berdasarkan Merek</h2>
    <div>
      <label for="categoryName">Pilih Merek yang Ada atau Ketik Nama Baru:</label>
      <input type="text" id="categoryName" list="categoryList" placeholder="Pilih atau ketik nama Merek..." />
      <datalist id="categoryList"></datalist>
    </div>

    <div class="category-block">
      <h3>Data Item Produk untuk Merek Terpilih</h3>
      <div id="elementsContainer" class="elements-list">
         <p>Pilih "Merek" di atas untuk memuat item produk.</p>
      </div>
      <button id="addElementBtn">+ Tambah Item Baru ke Merek Ini</button>
    </div>

    <button id="generateJsonBtn">
      Generate & Download Updated data.json
    </button>
  </div>

<script>
  // =================================================================
  // == (SKRIP DIPERBARUI TOTAL) ==
  // == Disesuaikan untuk format array [ { Merek, Kategori, ... } ] ==
  // =================================================================

  // (DIUBAH) Mulai sebagai array
  let existingData = [];

  const elementsContainer = document.getElementById('elementsContainer');
  const addElementBtn = document.getElementById('addElementBtn');
  const generateJsonBtn = document.getElementById('generateJsonBtn');
  const categoryNameInput = document.getElementById('categoryName');
  const loadJsonFile = document.getElementById('loadJsonFile');
  const categoryList = document.getElementById('categoryList');

  // --- 1. Muat File JSON ---
  loadJsonFile.addEventListener('change', (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const parsed = JSON.parse(e.target.result);

        // (DIUBAH) Pastikan data adalah array
        if (!Array.isArray(parsed)) {
            alert('Error: File JSON bukan array. Harap gunakan file data.json dari galeri.');
            return;
        }

        existingData = parsed;
        populateCategoryList(); // Panggil fungsi baru
        categoryNameInput.value = '';
        elementsContainer.innerHTML = '<p>JSON berhasil dimuat! Pilih "Merek" dari daftar untuk diedit, atau ketik nama baru.</p>';
        alert('JSON berhasil dimuat! Pilih "Merek" dari daftar untuk diedit, atau ketik nama baru.');
      } catch (err) {
        alert('Error: File JSON tidak valid. ' + err.message);
        existingData = [];
      }
    };
    reader.onerror = () => {
      alert('Gagal membaca file.');
    };
    reader.readAsText(file);
  });

  // --- 2. Isi Daftar Pilihan (berdasarkan Merek) ---
  function populateCategoryList() {
    categoryList.innerHTML = '';
    if (!Array.isArray(existingData)) return;

    // (DIUBAH) Ambil semua Merek unik dari array
    const mereks = [...new Set(existingData.map(item => item.Merek).filter(Boolean))].sort();

    for (const merekName of mereks) {
      const option = document.createElement('option');
      option.value = merekName;
      categoryList.appendChild(option);
    }
  }

  // --- 3. Tampilkan Item saat Merek Dipilih ---
  categoryNameInput.addEventListener('change', () => {
    const selectedMerek = categoryNameInput.value.trim();
    elementsContainer.innerHTML = ''; // Selalu bersihkan

    if (Array.isArray(existingData) && selectedMerek) {
      // (DIUBAH) Filter array untuk Merek yang cocok
      const elements = existingData.filter(item => item.Merek === selectedMerek);

      if (elements.length > 0) {
        console.log(`Memuat ${elements.length} data untuk Merek: ${selectedMerek}`);
        // Tampilkan semua elemen yang cocok
        for (const item of elements) {
          elementsContainer.appendChild(createElementRow(item));
        }
      } else {
        // Ini adalah Merek baru, tambahkan satu baris kosong
        console.log(`Membuat baris baru untuk Merek baru: ${selectedMerek}`);
        // Kirim Merek ke baris baru agar terisi otomatis
        elementsContainer.appendChild(createElementRow({ Merek: selectedMerek }));
      }
    } else {
      elementsContainer.innerHTML = '<p>Pilih "Merek" di atas untuk memuat item produk.</p>';
    }
  });

  // --- 4. Buat Baris Input (DIPERBARUI TOTAL) ---
  function createElementRow(data = {}) {
    const div = document.createElement('div');
    div.classList.add('element-row');

    // (DIUBAH) Siapkan data baru
    const merek = escapeHtml(data.Merek || '');
    const kategori = escapeHtml(data.Kategori || '');
    const sub1 = escapeHtml(data.SubKategori1 || '');
    const sub1_2 = escapeHtml(data.SubKategori1_2 || '');
    const gambar = escapeHtml(data.Gambar || '');

    const placeholderImg = 'https://via.placeholder.com/400x200.png?text=Image+Preview';
    const imgSrc = gambar || placeholderImg;

    // Dapatkan nama file untuk preview
    let imageNameTitle = 'Nama File...';
    if (gambar) {
      try {
        const fullFilename = gambar.split('/').pop();
        const filenameWithoutExt = fullFilename.replace(/\.(jpg|jpeg|png)$/i, '');
        imageNameTitle = filenameWithoutExt.replace(/_/g, ' ');
      } catch (e) {
        // biarkan default
      }
    }

    const hierarki = `${merek} ${kategori ? '&rarr; ' + kategori : ''} ${sub1 ? '&rarr; ' + sub1 : ''}`;

    div.innerHTML = `
      <button class="remove-btn" title="Hapus elemen ini">Ã—</button>

      <div class="element-row-flex">

        <div class="element-inputs">
          <label>Merek: (Otomatis dari kategori terpilih)</label>
          <input type="text" class="field-merek" placeholder="Merek" value="${merek}" required readonly style="background:#eee; color:#555;" />

          <label>URL Gambar:</label>
          <input type="text" class="field-gambar" placeholder="https://.../gambar.jpg" value="${gambar}" required />

          <label>Kategori:</label>
          <input type="text" class="field-kategori" placeholder="Kategori" value="${kategori}" required />

          <label>Sub Kategori 1:</label>
          <input type="text" class="field-sub1" placeholder="Sub Kategori 1 (Opsional)" value="${sub1}" />

          <label>Sub Kategori 1.2:</label>
          <input type="text" class="field-sub1_2" placeholder="Sub Kategori 1.2 (Opsional)" value="${sub1_2}" />
        </div>

        <div class="element-preview">
          <div class="preview-card">
            <img class="preview-image" src="${imgSrc}" alt="Preview" onerror="this.src='${placeholderImg}'; this.onerror=null;" />
            <div class="preview-content">
              <h4 class="preview-title">${escapeHtml(imageNameTitle)}</h4>
              <p class="preview-desc">${hierarki}</p>
              <span class="preview-date">${escapeHtml(sub1_2 || '...')}</span>
            </div>
          </div>
        </div>

      </div>      `;

    // Event tombol hapus elemen
    div.querySelector('.remove-btn').addEventListener('click', () => {
      if (confirm('Hapus item produk ini?')) {
        div.remove();
      }
    });

    return div;
  }

  // --- 5. Tambah Elemen Baru ---
  addElementBtn.addEventListener('click', () => {
    const currentMerek = categoryNameInput.value.trim();
    if (!currentMerek) {
      alert('Pilih atau ketik "Merek" terlebih dahulu sebelum menambah item baru.');
      categoryNameInput.focus();
      return;
    }
    // (DIUBAH) Tambah baris baru dengan Merek yang sudah terisi
    const newRow = createElementRow({ Merek: currentMerek });
    elementsContainer.appendChild(newRow);
  });

  // --- 6. Live Preview (DIPERBARUI TOTAL) ---
  elementsContainer.addEventListener('input', (e) => {
    const input = e.target;
    const row = input.closest('.element-row');
    if (!row) return;

    // Ambil SEMUA nilai dari form untuk membangun preview
    const merek = row.querySelector('.field-merek').value;
    const kategori = row.querySelector('.field-kategori').value;
    const sub1 = row.querySelector('.field-sub1').value;
    const sub1_2 = row.querySelector('.field-sub1_2').value;
    const gambar = row.querySelector('.field-gambar').value;

    // Perbarui Gambar Preview dan Judul
    if (input.classList.contains('field-gambar')) {
      const imgEl = row.querySelector('.preview-image');
      const placeholder = 'https://via.placeholder.com/400x200.png?text=Image+Preview';
      imgEl.src = gambar || placeholder;
      imgEl.onerror = () => { imgEl.src = placeholder; imgEl.onerror = null; };

      let imageNameTitle = 'Nama File...';
      if (gambar) {
        try {
          const fullFilename = gambar.split('/').pop();
          const filenameWithoutExt = fullFilename.replace(/\.(jpg|jpeg|png)$/i, '');
          imageNameTitle = filenameWithoutExt.replace(/_/g, ' ');
        } catch (e) {}
      }
      row.querySelector('.preview-title').textContent = escapeHtml(imageNameTitle);
    }

    // Perbarui Teks Preview (Hierarki)
    const hierarki = `${merek} ${kategori ? '&rarr; ' + escapeHtml(kategori) : ''} ${sub1 ? '&rarr; ' + escapeHtml(sub1) : ''}`;
    row.querySelector('.preview-desc').innerHTML = hierarki;
    row.querySelector('.preview-date').textContent = escapeHtml(sub1_2 || '...');
  });

  // --- 7. Generate JSON (DIPERBARUI TOTAL) ---
  generateJsonBtn.addEventListener('click', () => {
    const currentMerek = categoryNameInput.value.trim();
    if (!currentMerek) {
      alert('Nama "Merek" (kategori utama) harus diisi!');
      categoryNameInput.focus();
      return;
    }

    const elementDivs = [...elementsContainer.querySelectorAll('.element-row')];
    if (elementDivs.length === 0) {
      alert('Tambahkan minimal satu item produk!');
      return;
    }

    const newElementsForThisMerek = [];

    for (let div of elementDivs) {
      // (DIUBAH) Buat objek item
      const item = {
        Merek: div.querySelector('.field-merek').value.trim(),
        Kategori: div.querySelector('.field-kategori').value.trim(),
        SubKategori1: div.querySelector('.field-sub1').value.trim(),
        SubKategori1_2: div.querySelector('.field-sub1_2').value.trim(),
        Gambar: div.querySelector('.field-gambar').value.trim()
      };

      // Validasi
      if (!item.Merek || !item.Kategori || !item.Gambar) {
        alert('Merek, Kategori, dan URL Gambar harus diisi di semua item.');
        div.querySelector('.field-kategori').focus(); // Fokus ke field yang mungkin kosong
        return;
      }

      // Ganti string kosong dengan "" agar konsisten
      if (item.SubKategori1 === '') item.SubKategori1 = "";
      if (item.SubKategori1_2 === '') item.SubKategori1_2 = "";

      newElementsForThisMerek.push(item);
    }

    // (Sangat Penting) Gabungkan data baru dengan data lama

    // 1. Ambil semua data LAMA yang BUKAN Merek saat ini
    const otherData = (Array.isArray(existingData))
       ? existingData.filter(item => item.Merek !== currentMerek)
       : [];

    // 2. Gabungkan data lama (yang tidak tersentuh) + data baru (yang diedit)
    const finalDataArray = [...otherData, ...newElementsForThisMerek];

    // Urutkan (opsional tapi bagus)
    finalDataArray.sort((a, b) => {
        if (a.Merek !== b.Merek) return a.Merek.localeCompare(b.Merek);
        if (a.Kategori !== b.Kategori) return a.Kategori.localeCompare(b.Kategori);
        if (a.SubKategori1 !== b.SubKategori1) return a.SubKategori1.localeCompare(b.SubKategori1);
        return a.Gambar.localeCompare(b.Gambar);
    });

    // 3. Buat JSON
    const jsonStr = JSON.stringify(finalDataArray, null, 2);
    downloadJSON(jsonStr, 'data_updated.json');
  });

  // --- Fungsi Bantuan (Tidak Berubah) ---
  function escapeHtml(text) {
    if (!text) return '';
    return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
  }

  function downloadJSON(content, filename) {
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    setTimeout(() => {
      URL.revokeObjectURL(url);
    }, 100);
  }

  // (DIHAPUS) window.addEventListener('load', ...)
  // Tidak perlu lagi menambah baris kosong di awal.

</script>
</body>
</html>