name: ğŸš¨ Major Dependency Upgrade (Scheduled & Manual)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 */3 *' # tiap 3 bulan (02:00 UTC â‰ˆ 10:00 WIB)

jobs:
  major-upgrade:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ğŸ§© Checkout kode
        uses: actions/checkout@v6

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: ğŸ“¦ Install dependencies
        run: npm ci || npm install

      - name: ğŸ” Preview major upgrades
        run: |
          npm install -g npm-check-updates
          ncu --target latest --format group

      - name: ğŸš¨ Apply major upgrades
        run: |
          ncu -u --target latest
          npm install

      - name: ğŸ§ª Audit, Lint & Test
        run: |
          npm audit --omit=dev || true
          npm run lint --if-present || true
          npm run test --if-present || true

      - name: ğŸ” Cek perubahan
        id: check_changes
        run: |
          [[ $(git status --porcelain package.json package-lock.json) ]] \
            && echo "changes=true" >> $GITHUB_OUTPUT \
            || echo "changes=false" >> $GITHUB_OUTPUT

      - name: ğŸ“¨ Buat Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          branch: chore/major-upgrade-${{ github.run_id }}
          title: 'chore: major dependency upgrades'
          commit-message: 'chore: upgrade dependencies (major versions)'
          body: |
            ğŸš¨ **Major Dependency Upgrade**

            Perubahan ini mencakup:
            - Upgrade lintas versi mayor
            - Potensi breaking change
            - Sudah melalui audit, lint, dan test dasar

            Mohon review sebelum merge.
          labels: dependencies, major, breaking-change
          reviewers: frijal
          draft: false

      - name: â„¹ï¸ Tidak ada perubahan
        if: steps.check_changes.outputs.changes == 'false'
        run: echo "ğŸ’¤ Tidak ada dependency major yang perlu di-upgrade."
