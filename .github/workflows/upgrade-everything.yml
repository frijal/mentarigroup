name: 🛠️ Pemeliharaan Dependensi (Upgrade & Cleanup)

on:
  # 1. Bisa dijalankan manual dari tab "Actions"
  workflow_dispatch:
  
  # 2. Dijalankan otomatis setiap bulan, tanggal 1, jam 2 UTC
  schedule:
    - cron: '0 2 1 * *'

jobs:
  maintenance-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write       # Izin untuk commit/push ke branch
      pull-requests: write  # Izin untuk membuat PR

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies (untuk tools)
        run: npm install # Install ncu dan depcheck dari devDependencies

      - name: Make script executable
        run: chmod +x ext/cleanup.js # Pastikan skrip cleanup bisa dijalankan

      # --- BAGIAN 1: DARI WORKFLOW 'UPGRADE' ---
      - name: 1. Upgrade dependencies (minor & patch)
        run: |
          npm install -g npm-check-updates # Install ncu di runner
          ncu -u --target minor
          echo "Selesai upgrade minor/patch."

      # --- BAGIAN 2: DARI WORKFLOW 'CLEANUP' ---
      - name: 2. Cleanup unused packages
        run: |
          echo "Menjalankan skrip cleanup..."
          ext/cleanup.js # Skrip ini akan uninstall DAN npm install ulang

      # --- BAGIAN 3: GABUNGAN UNTUK MEMBUAT PR ---
      
      # Cek apakah langkah 1 atau 2 menghasilkan perubahan
      - name: Check for changes
        id: check_changes
        run: |
          if [[ $(git status --porcelain package.json package-lock.json) ]]; then
            echo "Perubahan terdeteksi."
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          else
            echo "Tidak ada perubahan."
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          fi

      # Hanya jalankan test jika ada perubahan
      - name: Run tests (if changes detected)
        if: steps.check_changes.outputs.changes_detected == 'true'
        run: |
          npm run build --if-present
          npm test --if-present

      # Buat PR jika ada perubahan
      - name: Create Pull Request (if changes detected)
        if: steps.check_changes.outputs.changes_detected == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: chore/auto-maintenance-${{ github.run_id }}
          title: 'chore: Upgrade (minor) & Cleanup Dependencies'
          commit-message: 'chore: Upgrade (minor) & Cleanup Dependencies'
          body: |
            PR otomatis ini melakukan dua hal:
            1.  **Upgrade:** Menggunakan `npm-check-updates` untuk dependensi minor/patch.
            2.  **Cleanup:** Menjalankan `ext/cleanup.js` untuk menghapus paket yang tidak terpakai.

            - Build dan test sudah dijalankan di CI.
            - Mohon review sebelum di-merge.
          labels: dependencies, chore, automated pr
          reviewers: frijal # Ganti dengan username GitHub Anda/tim
          draft: false
