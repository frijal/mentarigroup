name: ⚠️ Copy ke Branch Site Cloudflare

on:
  workflow_run:
    workflows: ["☢️ Build and Generate Site Files"] # Pastikan NAMA workflow pertama SAMA PERSIS
    types: [completed] # Hanya berjalan jika workflow pertama SELESAI
  schedule:
    - cron: '0 10 * * *' 
  push:
    branches:
      - main  
  # ⬇️ Tambahkan filter paths di sini
    paths:
      - 'artikel.json'            # File spesifik di root
      - '_redirects'        # File spesifik di root
      - '_headers'          # File spesifik di root
      - '*.html'            # File HTML di root
      - '*.xml'             # File XML di root
      - '*.txt'             # File TXT di root
      - 'favicon.*'         # Pola file di root
      - 'icon.*'            # Pola file di root
      - 'logo.*'            # Pola file di root
      - 'thumbnail.*'       # Pola file di root
      - '*.webmanifest'     # Pola file di root
      # Anda TIDAK perlu menambahkan file/folder lain seperti README.md, .github/**, dll.

  workflow_dispatch: # Pemicu manual tetap ada

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:    
      # Checkout branch main (source)
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: source

      # Checkout branch site (target) - Hanya jika perlu perbandingan
      # Jika Anda HANYA deploy, langkah checkout 'site' ini bisa dihapus
      # Jika Anda PERLU membandingkan (seperti di kode asli), biarkan saja
      - name: Checkout site branch (for comparison) 
        uses: actions/checkout@v4
        with:
          ref: site
          path: site

      # Buat direktori sementara
      - name: Create clean directory
        run: mkdir deploy_dir

      # Salin hanya file yang diizinkan dari source
      - name: Sync allowed files to deploy directory
        run: |
          echo "Syncing relevant files to deploy_dir..."
          rsync -a --delete \
            --include='artikel/***' \
            --include='ext/***' \
            --include='img/***' \
            --include='artikel.json' \
            --include='_redirects' \
            --include='_headers' \
            --include='*.html' \
            --include='*.xml' \
            --include='*.txt' \
            --include='favicon.*' \
            --include='icon.*' \
            --include='logo.*' \
            --include='thumbnail.*' \
            --include='*.webmanifest' \
            --exclude='*' \
            source/ deploy_dir/
          echo "Sync complete."

      # Cek perubahan (Opsional tapi direkomendasikan jika checkout 'site' masih ada)
      - name: Check for changes vs deployed site
        id: check_changes
        run: |
          echo "Checking for differences between deploy_dir and site branch..."
          # Bandingkan deploy_dir dengan checkout branch 'site'
          if git diff --no-index --quiet deploy_dir/ site/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✅ No effective changes detected compared to the deployed site."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "⚠️ Changes detected compared to the deployed site. Proceeding with deployment."
          fi
        # Jalankan langkah ini meskipun workflow dipicu oleh perubahan kecil (misal hanya 1 file)
        # agar kita bisa skip deploy jika hasil build-nya ternyata sama dengan yang sudah live.

      # Deploy hanya jika ada perubahan efektif setelah build/sync
      - name: Deploy to site branch
        # Gunakan output dari langkah check_changes
        if: steps.check_changes.outputs.changed == 'true' 
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./deploy_dir
          publish_branch: site
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          force_orphan: false 
          keep_files: false
